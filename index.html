<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スプレッドシート データ表示</title>

    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #data-table { width:100%; }
    </style>
</head>
<body>

<h1>✅ スプレッドシート データ一覧</h1>

<table id="data-table" class="display">
    <thead>
        <tr>
            <th>No.</th>
            <th>(性別別)ID</th>
            <th>氏名</th>
            <th>性別</th>
            <th>Time</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

<script>
const SPREADSHEET_ID = "15o-YvVRYn6yvpsMcEFUI4eZ-0HIWWpiAzCwR9d7a6bc";
const GID = "586609283";

// gviz API の JSON 出力
const QUERY_URL =
  `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;

// DataTables 初期化
function initializeDataTable(tableData) {
    $('#data-table').DataTable({
        data: tableData,
        columns: [
            { title: "No." },
            { title: "(性別別)ID" },
            { title: "氏名" },
            { title: "性別" },
            { title: "Time" }
        ],
        language: {
            url: "https://cdn.datatables.net/plug-ins/2.0.8/i18n/ja.json"
        }
    });
}

// gviz JSON を fetch で取得
async function loadSheet() {
    try {
        const res = await fetch(QUERY_URL);
        const text = await res.text();

        // gviz は JSON っぽいが "google.visualization.Query.setResponse(...)" で囲まれているため除去
        const json = JSON.parse(text.replace(/.*setResponse\(/, "").replace(/\);?$/, ""));

        const rows = json.table.rows;
        const data = [];

        rows.forEach(r => {
            const c = r.c;
            data.push([
                c[0]?.v ?? "",
                c[1]?.v ?? "",
                c[2]?.v ?? "",
                c[3]?.v ?? "",
                c[4]?.v ?? ""
            ]);
        });

        initializeDataTable(data);

    } catch (err) {
        console.error("エラー:", err);
        $('#data-table').after(`<p style="color:red;">⚠️ データの取得に失敗しました: ${err}</p>`);
    }
}

// ページ読み込み時に実行
loadSheet();
</script>

</body>
</html>
